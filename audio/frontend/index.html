<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Music Transcriber — Improved UI</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{
      --bg: #f8fafc; --card: #ffffff; --muted: #475569; --accent: #06b6d4;
      font-family: Inter, Roboto, "Helvetica Neue", Arial;
    }
    body{ background: linear-gradient(180deg,#ffffff 0%, #f1f5f9 100%); color:#0f1724; margin:0; padding:28px; min-height:100vh; display:flex; justify-content:center; }
    .container{ width:100%; max-width:1000px; }
    .card{ background:var(--card); border-radius:12px; padding:16px; box-shadow: 0 8px 28px rgba(15,23,42,0.06); margin-bottom:14px; }
    .row{ display:flex; gap:12px; align-items:center; }
    input[type=file]{ color:inherit; }
    button{ background:var(--accent); color:#ffffff; border:0; padding:8px 12px; border-radius:8px; cursor:pointer; font-weight:600; }
    #out{ white-space:pre-wrap; color:var(--muted); font-family: monospace; margin-top:8px; }
    .notes-table{ width:100%; border-collapse:collapse; margin-top:8px; }
    .notes-table th,.notes-table td{ text-align:left; padding:8px; font-size:13px; color:#0f1724; border-bottom:1px solid rgba(15,23,42,0.06); }
    .muted { color:var(--muted); font-size:13px; }
    #canvasWrap{ width:100%; overflow:auto; background:linear-gradient(180deg, rgba(2,6,23,0.03), rgba(2,6,23,0.01)); border-radius:8px; padding:8px; }
    canvas{ background: linear-gradient(180deg, rgba(15,23,42,0.03), rgba(15,23,42,0.01)); border-radius:6px; display:block; }
    .progress{ height:8px; background:rgba(15,23,42,0.06); border-radius:999px; overflow:hidden; }
    .progress > i{ display:block; height:100%; width:0%; background:linear-gradient(90deg,#7dd3fc,#06b6d4); transition: width .2s; }
    .small{ font-size:13px; color:var(--muted); }
    a.link{ color:var(--accent); text-decoration:none; font-weight:600; }
  </style>
</head>
<body>
  <div class="container">
    <header><h1>MuTraPro</h1></header>

    <div class="card">
      <div class="row">
        <input id="file" type="file" accept=".wav,.mp3,.flac,.ogg,.aiff"/>
        <button id="sendBtn">Transcribe</button>
        <div style="flex:1"></div>
        <div class="small muted">API: <span id="apiUrl">/trans</span></div> 
      </div>

      <div style="margin-top:10px;">
        <div class="progress"><i id="bar"></i></div>
      </div>

      <div id="out" class="small muted card" style="margin-top:12px;">
        Chưa có kết quả. Chọn audio và bấm "Transcribe".
      </div>
    </div>

    <div id="visualArea" style="display:none;">
      <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <div><strong>Kết quả phân tích nốt</strong> <span class="muted small" id="meta"></span></div>
          <div><a id="midiLink" class="link" href="#" target="_blank" style="display:none">Tải MIDI</a></div>
        </div>

        <div id="canvasWrap" style="margin-top:12px;">
          <canvas id="prCanvas" height="280"></canvas>
        </div>

        <table class="notes-table" id="notesTable">
          <thead><tr><th>#</th><th>Nốt</th><th>Bắt đầu (s)</th><th>Kết thúc (s)</th><th>Độ dài (s)</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

<script>
/*
  Thay đổi chính: đặt API mặc định thành localhost:8000/trans
  Nếu bạn chạy backend ở cổng/host khác, sửa biến API_BASE.
*/
const API_BASE = (typeof API_BASE_OVERRIDE !== 'undefined') ? API_BASE_OVERRIDE : 'http://localhost:8000';
const API = API_BASE + '/trans';
document.getElementById('apiUrl').innerText = API;

const fileInput = document.getElementById('file');
const sendBtn = document.getElementById('sendBtn');
const out = document.getElementById('out');
const bar = document.getElementById('bar');
const visualArea = document.getElementById('visualArea');
const notesTableBody = document.querySelector('#notesTable tbody');
const prCanvas = document.getElementById('prCanvas');
const midiLink = document.getElementById('midiLink');
const meta = document.getElementById('meta');

function setProgress(p){ bar.style.width = Math.max(0, Math.min(100,p*100)) + '%'; }

function noteNameToMidi(note){
  const letters = {'C':0,'C#':1,'D':2,'D#':3,'E':4,'F':5,'F#':6,'G':7,'G#':8,'A':9,'A#':10,'B':11};
  const m = note.match(/^([A-G]#?)(-?\d+)/);
  if(!m) return null;
  const name = m[1], oct = parseInt(m[2],10);
  return (oct+1)*12 + letters[name];
}

function drawPianoRoll(events){
  const ctx = prCanvas.getContext('2d');
  const minT = 0;
  const maxT = Math.max(...events.map(e=>e.end), 1);
  const midiVals = events.map(e=>noteNameToMidi(e.note)).filter(v=>v!==null);
  const minP = Math.min(...midiVals) - 2;
  const maxP = Math.max(...midiVals) + 2;

  const w = Math.max(800, Math.round((Math.max(4, maxT))*120));
  prCanvas.width = w;
  prCanvas.height = 280;
  ctx.clearRect(0,0,prCanvas.width, prCanvas.height);

  ctx.fillStyle = 'rgba(255,255,255,0.02)';
  ctx.fillRect(0,0,prCanvas.width, prCanvas.height);
  ctx.strokeStyle = 'rgba(0,0,0,0.06)';
  ctx.lineWidth = 1;
  const pxPerSec = prCanvas.width / (maxT - minT + 1e-6);
  for(let s=0; s<=Math.ceil(maxT); s++){
    const x = Math.round(s * pxPerSec) + 0.5;
    ctx.beginPath();
    ctx.moveTo(x, 0);
    ctx.lineTo(x, prCanvas.height);
    ctx.stroke();
    ctx.fillStyle = 'rgba(0,0,0,0.12)';
    ctx.font = '11px Inter, Arial';
    ctx.fillText(s + 's', x+4, 12);
  }

  const pitchSpan = maxP - minP + 1;
  const rowH = prCanvas.height / pitchSpan;
  ctx.strokeStyle = 'rgba(0,0,0,0.04)';
  for(let i=0;i<pitchSpan;i++){
    const y = i*rowH;
    ctx.beginPath();
    ctx.moveTo(0, Math.round(y)+0.5);
    ctx.lineTo(prCanvas.width, Math.round(y)+0.5);
    ctx.stroke();
  }

  for(let ev of events){
    const midi = noteNameToMidi(ev.note);
    if(midi===null) continue;
    const px = (ev.start - minT) * pxPerSec;
    const pw = Math.max(3, (ev.end - ev.start) * pxPerSec);
    const py = (maxP - midi) * rowH;
    const hue = 200 - ((midi % 12) / 12) * 120;
    ctx.fillStyle = `hsla(${hue}, 80%, 60%, 0.9)`;
    const r = Math.max(2, rowH/4);
    const height = Math.max(6, rowH-4);
    roundRect(ctx, px+2, py+2, pw-4, height, r);
    ctx.fillStyle = 'rgba(2,6,23,0.9)';
    ctx.font = '11px Inter, Arial';
    ctx.fillText(ev.note, px+6, py+height-6);
  }
}

function roundRect(ctx, x, y, w, h, r){
  ctx.beginPath();
  ctx.moveTo(x+r,y);
  ctx.arcTo(x+w,y, x+w,y+h, r);
  ctx.arcTo(x+w,y+h, x,y+h, r);
  ctx.arcTo(x,y+h, x,y, r);
  ctx.arcTo(x,y, x+w,y, r);
  ctx.closePath();
  ctx.fill();
}

function clearResults(){ notesTableBody.innerHTML = ''; visualArea.style.display = 'none'; midiLink.style.display = 'none'; }

function makeAbsoluteUrl(path){
  if(!path) return null;
  if(path.startsWith('http://') || path.startsWith('https://')) return path;
  // if path starts with '/', prefix API_BASE
  if(path.startsWith('/')) return API_BASE + path;
  // otherwise relative path
  return API_BASE + '/' + path;
}

function displayResults(events, midi_file){
  notesTableBody.innerHTML = '';
  events.forEach((ev,i)=>{
    const tr = document.createElement('tr');
    const tdIdx = document.createElement('td'); tdIdx.innerText = (i+1);
    const tdNote = document.createElement('td'); tdNote.innerText = ev.note;
    const tdStart = document.createElement('td'); tdStart.innerText = ev.start.toFixed(3);
    const tdEnd = document.createElement('td'); tdEnd.innerText = ev.end.toFixed(3);
    const tdDur = document.createElement('td'); tdDur.innerText = (ev.end-ev.start).toFixed(3);
    tr.appendChild(tdIdx); tr.appendChild(tdNote); tr.appendChild(tdStart); tr.appendChild(tdEnd); tr.appendChild(tdDur);
    notesTableBody.appendChild(tr);
  });
  meta.innerText = `Tổng ${events.length} nốt — thời lượng: ${ (Math.max(...events.map(e=>e.end))).toFixed(3) } s`;
  if(midi_file){
    midiLink.href = makeAbsoluteUrl(midi_file);
    midiLink.style.display = 'inline';
    midiLink.download = midi_file.split('/').pop();
  } else midiLink.style.display = 'none';

  visualArea.style.display = 'block';
  drawPianoRoll(events);
}

sendBtn.onclick = async ()=>{
  if(!fileInput.files || fileInput.files.length===0){ alert("Chọn file audio trước"); return; }
  const f = fileInput.files[0];
  clearResults();
  out.innerText = `Uploading ${f.name} ...`;
  setProgress(0.05);

  const form = new FormData();
  form.append('file', f, f.name);

  try{
    const resp = await fetch(API, { method:'POST', body: form });
    if(!resp.ok) throw new Error('Server trả lỗi ' + resp.status);
    setProgress(0.5);
    const j = await resp.json();
    setProgress(0.9);

    let events = null;
    // server now returns `events` (list of dicts). Accept both j.events and j.notes for backward compatibility.
    if((j.events && Array.isArray(j.events)) || (j.notes && Array.isArray(j.notes))){
      const raw = j.events && Array.isArray(j.events) ? j.events : j.notes;
      // raw may be list of dicts or lists
      events = raw.map(item=>{
        if(Array.isArray(item)) return {note: item[0], start: parseFloat(item[1]), end: parseFloat(item[2])};
        if(typeof item === 'object') return {note: item.note || item.name || item[0], start: parseFloat(item.start || item[1] || 0), end: parseFloat(item.end || item[2] || (item.start ? item.start + 0.0 : 0))};
        return null;
      }).filter(Boolean);
    } else if(j.transcription_text && typeof j.transcription_text === 'string'){
      const parts = j.transcription_text.trim().split(/\s+/).filter(Boolean);
      let cursor = 0.0;
      events = [];
      for(const p of parts){
        const m = p.match(/^([A-G]#?\-?\d+)\((\d*\.?\d+)s\)$/);
        if(!m) continue;
        const note = m[1];
        const dur = parseFloat(m[2]);
        const start = cursor;
        const end = cursor + dur;
        events.push({note, start, end});
        cursor = end;
      }
      if(events.length===0 && j.transcription_text){
        out.innerText = "Không parse được transcription_text tự động — nội dung:\n" + j.transcription_text;
      }
    } else {
      out.innerText = "Không nhận được dữ liệu nốt từ server. Phần trả về:\n" + JSON.stringify(j, null, 2);
    }

    out.innerText = "Hoàn tất.";
    setProgress(1.0);

    if(events && events.length>0){
      events = events.sort((a,b)=>a.start - b.start);
      // accept j.midi_file string (like "/outputs/xxx.mid")
      displayResults(events, j.midi_file ? j.midi_file : null);
    }
  }catch(err){
    console.error(err);
    out.innerText = "Lỗi: " + err;
    setProgress(0);
  }
};
</script>
</body>
</html>
